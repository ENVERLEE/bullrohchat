{% extends "base.html" %}

{% block title %}크롤러 설정 - 불로챗 관리자{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">크롤러 설정</h1>
        <a href="{{ url_for('config') }}" class="text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left mr-1"></i> 설정 메뉴로 돌아가기
        </a>
    </div>
    
    <div class="bg-white shadow-md rounded-lg p-6 mb-8">
        <form method="POST" action="{{ url_for('crawler_config') }}" id="crawlerForm">
            <div class="space-y-6">
                <!-- Crawler Settings -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">크롤링 설정</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="max_posts" class="block text-sm font-medium text-gray-700 mb-1">최대 크롤링할 게시글 수</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <input type="number" id="max_posts" name="max_posts" 
                                       min="1" max="100" 
                                       value="{{ config.max_posts }}" 
                                       class="focus:ring-blue-500 focus:border-blue-500 block w-full pr-12 sm:text-sm border-gray-300 rounded-md"
                                       required>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">개</span>
                                </div>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">한 번에 크롤링할 최대 게시글 수를 설정하세요. (1-100)</p>
                        </div>
                        
                        <div class="flex items-end">
                            <button type="button" id="testCrawlBtn" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-spider mr-2"></i> 테스트 크롤링 실행
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Crawl Schedule -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">자동 크롤링 일정</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">자동 크롤링 주기</label>
                            <div class="flex space-x-4">
                                <div class="flex items-center">
                                    <input id="schedule_daily" name="schedule" type="radio" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <label for="schedule_daily" class="ml-2 block text-sm text-gray-700">
                                        매일
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input id="schedule_weekly" name="schedule" type="radio" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="schedule_weekly" class="ml-2 block text-sm text-gray-700">
                                        매주
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input id="schedule_manual" name="schedule" type="radio" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="schedule_manual" class="ml-2 block text-sm text-gray-700">
                                        수동
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div id="timePicker" class="flex items-end">
                            <div>
                                <label for="crawl_time" class="block text-sm font-medium text-gray-700 mb-1">실행 시간</label>
                                <input type="time" id="crawl_time" name="crawl_time" value="02:00" 
                                       class="focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Save Button -->
                <div class="pt-4 border-t">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-save mr-2"></i> 설정 저장
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Crawl Now Card -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-8 border-l-4 border-yellow-400">
        <div class="flex items-start">
            <div class="flex-shrink-0 bg-yellow-100 p-2 rounded-full">
                <i class="fas fa-sync-alt text-yellow-600"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">지금 크롤링 실행</h3>
                <div class="mt-2 text-sm text-gray-600">
                    <p>설정한 크롤링 옵션으로 지금 바로 크롤링을 실행합니다. 블로그에 새로운 글이 있다면 자동으로 감지하여 업데이트합니다.</p>
                </div>
                <div class="mt-4">
                    <button type="button" id="startCrawlBtn" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                        <i class="fas fa-play mr-2"></i> 지금 크롤링 시작
                    </button>
                    <div id="crawlStatus" class="mt-2 text-sm text-blue-600 hidden">
                        <i class="fas fa-spinner fa-spin mr-1"></i> 크롤링을 실행 중입니다. 잠시만 기다려주세요...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Crawl Logs -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">최근 크롤링 기록</h2>
        </div>
        <div class="bg-gray-50 p-4 text-center">
            <p class="text-sm text-gray-500">최근 크롤링 기록이 없습니다.</p>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Start Crawl Button
    const startCrawlBtn = document.getElementById('startCrawlBtn');
    const crawlStatus = document.getElementById('crawlStatus');
    
    if (startCrawlBtn) {
        startCrawlBtn.addEventListener('click', function() {
            const maxPosts = document.getElementById('max_posts').value;
            
            // Show loading status
            crawlStatus.classList.remove('hidden');
            startCrawlBtn.disabled = true;
            
            // Send request to start crawling
            fetch('/crawl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `max_posts=${encodeURIComponent(maxPosts)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    crawlStatus.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i> 크롤링이 시작되었습니다. 잠시 후 새로고침 해주세요.';
                    crawlStatus.classList.remove('text-blue-600');
                    crawlStatus.classList.add('text-green-600');
                } else {
                    throw new Error(data.message || '크롤링을 시작하는 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                crawlStatus.innerHTML = `<i class="fas fa-exclamation-circle text-red-500 mr-1"></i> 오류: ${error.message}`;
                crawlStatus.classList.remove('text-blue-600');
                crawlStatus.classList.add('text-red-600');
            })
            .finally(() => {
                startCrawlBtn.disabled = false;
                // Hide status after 5 seconds
                setTimeout(() => {
                    crawlStatus.classList.add('hidden');
                    // Reset status
                    setTimeout(() => {
                        crawlStatus.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 크롤링을 실행 중입니다. 잠시만 기다려주세요...';
                        crawlStatus.classList.remove('text-green-600', 'text-red-600');
                        crawlStatus.classList.add('text-blue-600');
                    }, 1000);
                }, 5000);
            });
        });
    }
    
    // Test Crawl Button
    const testCrawlBtn = document.getElementById('testCrawlBtn');
    if (testCrawlBtn) {
        testCrawlBtn.addEventListener('click', function() {
            const maxPosts = document.getElementById('max_posts').value;
            
            // Show loading status
            const originalText = testCrawlBtn.innerHTML;
            testCrawlBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 테스트 중...';
            testCrawlBtn.disabled = true;
            
            // Simulate test (in a real app, this would be an API call)
            setTimeout(() => {
                alert(`테스트 크롤링이 완료되었습니다. 최대 ${maxPosts}개의 게시글을 크롤링합니다.`);
                testCrawlBtn.innerHTML = originalText;
                testCrawlBtn.disabled = false;
            }, 1500);
        });
    }
});
</script>
{% endblock %}
